import requests
import os
import json

BOT_TOKEN = os.getenv("BOT_TOKEN")
CHAT_ID = os.getenv("CHAT_ID")

# ØªÙˆØ§Ø¨Ø¹ Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª
def get_fx():
    res = requests.get("https://api.exchangeratesapi.io/latest?symbols=USD,EUR,GBP")
    data = res.json()["rates"]
    return data  # Ù…Ø«Ù„Ø§Ù‹ {"USD":39_000, ...}

def get_btc():
    res = requests.get("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd")
    return {"BTC": res.json()["bitcoin"]["usd"]}

def get_gold():
    res = requests.get("https://api.metals-api.com/v1/latest?access_key=" + os.getenv("METALS_KEY") + "&symbols=XAU&base=USD")
    rate_usd_per_oz = res.json()["rates"]["XAU"]
    usd_to_irr = get_fx()["USD"]
    # ØªØ¨Ø¯ÛŒÙ„ Ù‡Ø± Ú¯Ø±Ù… Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¨Ù‡ IRR:
    price_gram_18 = (1 / rate_usd_per_oz) * usd_to_irr * (18/24) * 31.1035
    return {"GOLD": round(price_gram_18)}

# Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù‚ÛŒÙ…Øª Ù‚Ø¨Ù„ÛŒ
def load_prev():
    if os.path.exists("prev.json"):
        return json.load(open("prev.json"))
    return {}

def save_prev(data):
    json.dump(data, open("prev.json","w"))

def format_line(name, new, old):
    sym = "ðŸ”µ" if name not in old or new>=old[name] else "ðŸ”´"
    return f"{name}: {new:,} {sym}"

def main():
    fx = get_fx()
    btc = get_btc()
    gold = get_gold()
    now = {**fx, **btc, **gold}
    prev = load_prev()

    lines = [format_line(k, now[k], prev) for k in now]
    msg = "ðŸ’± Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§:\n" + "\n".join(lines)

    data = {"chat_id": CHAT_ID, "text": msg}
    requests.post(f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage", data=data)

    save_prev(now)

if __name__=="__main__":
    main()
